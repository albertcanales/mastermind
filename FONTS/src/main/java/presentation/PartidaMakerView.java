package presentation;

import exceptions.presentation.PresentationException;

import javax.swing.*;
import java.awt.*;
import java.util.List;

/**
 * Vista per jugar una partida on el jugador és el maker
 * @author Albert Canales Ros
 */
public class PartidaMakerView {

    /**
     * Període al que mostrar les iteracions de la partida en la simulació
     */
    private static final Integer PERIOD_TIMER_MILLIS = 1000;

    /**
     * Controlador de presentació
     */
    private final ControladorPresentacio controladorPresentacio;

    /**
     * Panell contenidor
     */
    private JPanel panel;

    /**
     * Botó per tornar a la vista anterior (HomeView)
     */
    private JButton tornaButton;

    /**
     * Panell del taulell de la partida
     */
    private TaulellPanel taulellPanel;

    /**
     * Botó per parar la simulació
     */
    private JButton buttonParar;

    /**
     * Botó per acabar la simulació
     */
    private JButton buttonAcabar;

    /**
     * Botó per començar/seguir la simulació
     */
    private JButton buttonReproduir;

    /**
     * Llista dels intents de la partida
     */
    private List<List<Integer>> intentList;

    /**
     * Llista dels feedbacks de la partida
     */
    private List<List<Integer>> feedbackList;

    /**
     * Índex de l'últim intent que es mostra en la simulació
     */
    private Integer numIntentActual;

    /**
     * Timer per la simulació
     */
    private Timer timer;

    /**
     * Constructor per defecte de la vista
     */
    PartidaMakerView() throws PresentationException {
        controladorPresentacio = ControladorPresentacio.getInstance();
        $$$setupUI$$$();
        initComponents();
    }

    /**
     * Mètode per mostrar la vista
     */
    void show() {
        controladorPresentacio.setContent(panel);
        controladorPresentacio.setTitle("Partida Maker");
    }

    /**
     * Mètode per inicialitzar els components de la vista
     */
    private void initComponents() throws PresentationException {
        taulellPanel.setSolucioColors(controladorPresentacio.getSolucio());

        numIntentActual = 0;
        timer = new Timer(PERIOD_TIMER_MILLIS, actionEvent -> showNextIntent());
        buttonParar.setEnabled(false);

        if (!controladorPresentacio.isPartidaAcabada())
            controladorPresentacio.botSolve();

        intentList = controladorPresentacio.getIntents();
        feedbackList = controladorPresentacio.getFeedbacks();

        buttonParar.addActionListener(actionEvent -> buttonPararClick());
        buttonAcabar.addActionListener(actionEvent -> buttonAcabarClick());
        buttonReproduir.addActionListener(actionEvent -> buttonReproduirClick());
        tornaButton.addActionListener(actionEvent -> controladorPresentacio.showHomeView());
    }

    /**
     * Mètode que para la simulació
     */
    void buttonPararClick() {
        timer.stop();
        buttonReproduir.setEnabled(true);
        buttonAcabar.setEnabled(true);
        buttonParar.setEnabled(false);
    }

    /**
     * Mètode que acaba la simulació
     */
    void buttonAcabarClick() {
        timer.stop();
        buttonParar.setEnabled(false);
        buttonReproduir.setEnabled(false);
        buttonAcabar.setEnabled(false);
        try {
            taulellPanel.setIntentsColors(intentList);
            taulellPanel.setFeedbacksColors(feedbackList);
        } catch (PresentationException e) {
            e.printStackTrace();
            controladorPresentacio.showErrorDialog("No s'ha pogut mostrat tota la partida del bot");
        }
    }

    /**
     * Mètode per començar/continuar la simulació
     */
    void buttonReproduirClick() {
        buttonReproduir.setEnabled(false);
        buttonParar.setEnabled(true);
        timer.start();
    }

    /**
     * Mètode per mostrar el següent intent de la simulació
     */
    void showNextIntent() {
        try {
            taulellPanel.setIntentColors(numIntentActual, intentList.get(numIntentActual));
            taulellPanel.setFeedbackColors(numIntentActual, feedbackList.get(numIntentActual));
            numIntentActual++;
            if (numIntentActual == feedbackList.size()) {
                timer.stop();
                buttonAcabar.setEnabled(false);
                buttonParar.setEnabled(false);
            }
        } catch (PresentationException e) {
            throw new RuntimeException(e);
        }
    }

    /**
     * Method generated by IntelliJ IDEA GUI Designer
     * >>> IMPORTANT!! <<<
     * DO NOT edit this method OR call it in your code!
     *
     * @noinspection ALL
     */
    private void $$$setupUI$$$() {
        panel = new JPanel();
        panel.setLayout(new BorderLayout(0, 0));
        final JPanel panel1 = new JPanel();
        panel1.setLayout(new FlowLayout(FlowLayout.LEFT, 5, 5));
        panel.add(panel1, BorderLayout.NORTH);
        tornaButton = new JButton();
        tornaButton.setText("Torna");
        panel1.add(tornaButton);
        taulellPanel = new TaulellPanel();
        panel.add(taulellPanel.$$$getRootComponent$$$(), BorderLayout.CENTER);
        final JPanel panel2 = new JPanel();
        panel2.setLayout(new FlowLayout(FlowLayout.CENTER, 5, 5));
        panel.add(panel2, BorderLayout.SOUTH);
        buttonParar = new JButton();
        buttonParar.setText("Parar");
        panel2.add(buttonParar);
        buttonReproduir = new JButton();
        buttonReproduir.setText("Reproduir");
        panel2.add(buttonReproduir);
        buttonAcabar = new JButton();
        buttonAcabar.setText("Acabar");
        panel2.add(buttonAcabar);
    }

    /**
     * @noinspection ALL
     */
    public JComponent $$$getRootComponent$$$() {
        return panel;
    }

}
